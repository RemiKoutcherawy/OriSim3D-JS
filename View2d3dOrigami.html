<!DOCTYPE html>
<html lang="en">
<head>
  <title>Origami Three</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <style>
    body {
      background-color: #fff;
      margin: 0;
      overflow: hidden;
      border:1px solid darkblue;
    }
  </style>
</head>

<body>

<script src="./libs/three.js"></script>
<script src="./libs/OrbitControls.js"></script>
<script src="./libs/stats.min.js"></script>
<script src='./libs/dat.gui.min.js'></script>

<script type="module">

  import {Model} from "./src/Model.js";
  import {OrigamiGeometry} from "./src/OrigamiObject.js";
  import {View2d} from "./src/View2d.js";
  // import * as THREE from "./libs/three.module.js";

  let renderer, scene, camera, camera2, controls;
  let stats, gui, vue3d = false;

  // Inset viewport
  let insetWidth, insetHeight;

  // Origami Crease pattern
  let view2D;

  init();
  animate();

  function init() {

    renderer = new THREE.WebGLRenderer({antialias: false});
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    window.document.body.appendChild(renderer.domElement);

    // renderer.autoClear = false;

    scene = new THREE.Scene();

    camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 10, 2000);
    camera.position.set(-40, 0, 500);

    camera2 = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 10, 2000);
    camera2.position.set(-40, 0, 1000);

    // Orbit control
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.minDistance = 200;
    controls.maxDistance = 2000;

    const texture = new THREE.TextureLoader().load('./textures/back256x256.jpg');

    // Origami model
    const model = new Model();
    model.init([-200,-200, 200,-200, 200,200, -200,200]);

    // Origami geometry inspired by PlaneBufferGeometry
    const geometry = new OrigamiGeometry(model);
    const material = new THREE.MeshBasicMaterial({map: texture});

    const mesh = new THREE.Mesh(geometry, material);
    scene.add( mesh );

    // View2d for crease pattern
    view2D = new View2d(model);
    window.document.body.appendChild(view2D.canvas2d);

    // Listeners

    window.addEventListener('resize', onWindowResize, false);
    onWindowResize();

    stats = new Stats();
    window.document.body.appendChild(stats.dom);

    initGui();

  }

  function onWindowResize() {

    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();

    renderer.setSize(window.innerWidth, window.innerHeight);

    insetWidth = window.innerHeight / 4; // square
    insetHeight = window.innerHeight / 4;

    camera2.aspect = insetWidth / insetHeight;
    camera2.updateProjectionMatrix();

  }

  function animate() {

    requestAnimationFrame(animate);

    stats.update();

    // main scene
    if (vue3d){

      view2D.canvas2d.style.zIndex = '-1';
      // view2D.draw(); no need

      renderer.setClearColor(0xFFFFFF, 0);
      renderer.setViewport(0, 0, window.innerWidth, window.innerHeight);
      renderer.render(scene, camera);

    } else {

      view2D.canvas2d.style.zIndex = '0';
      view2D.draw();

      // inset scene in grey
      renderer.setClearColor(0x222222, 1);
      renderer.clearDepth(); // important!
      renderer.setScissorTest(true);
      renderer.setScissor(20, window.innerHeight - insetHeight - 20, insetWidth, insetHeight);
      renderer.setViewport(20, window.innerHeight - insetHeight - 20, insetWidth, insetHeight);
      camera2.position.copy(camera.position);
      camera2.quaternion.copy(camera.quaternion);
      renderer.render(scene, camera2);
      renderer.setScissorTest(false);
    }
  }

  // dat.GUI
  function initGui() {

    gui = new dat.GUI();

    const param = {
      'width (px)': 5,
      'vue3d': false
    };


    gui.add(param, 'width (px)', 1, 10).onChange(function (val) {
      console.log("val:"+val);
    });


    gui.add(param, 'vue3d').onChange(function (swaptest) {
      vue3d = swaptest;
    });

  }

</script>

</body>

</html>
